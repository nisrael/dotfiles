#!/bin/bash

set -e

# Detect OS
if [ -f /etc/os-release ]; then
  . /etc/os-release
  OS=$ID
elif [ "$(uname)" = "Darwin" ]; then
  OS="macos"
else
  OS="unknown"
fi

# Check for pip3 (only needed on non-Debian/Ubuntu systems)
if [ "$OS" != "ubuntu" ] && [ "$OS" != "debian" ]; then
  if ! command -v pip3 &>/dev/null; then
    echo "ERROR: pip3 is not installed."
    echo ""
    echo "To install pip3, run one of the following commands:"
    echo ""
    case "$OS" in
      ubuntu|debian)
        sudo apt install python3-pip pipx
        ;;
      fedora)
        sudo dnf install python3-pip pipx
        ;;
      macos)
        brew install python3 pipx
        ;;
      *)
        echo "Please install Python3, pip3 and pipx for your system"
        ;;
    esac
    echo ""
    exit 1
  fi
fi

# Install Ansible
if ! command -v ansible &>/dev/null; then
  echo "Installing Ansible..."
  case "$OS" in
    ubuntu|debian)
      sudo apt update && sudo apt install -y ansible
      ;;
    fedora)
      sudo dnf install -y ansible
      ;;
    macos)
      if command -v brew &>/dev/null; then
        brew install ansible
      else
        echo "Please install brew."
      fi
      ;;
    *)
      pipx install --user ansible
      ;;
  esac
else
  echo "Ansible is already installed."
fi

# Install Ansible Galaxy requirements
echo "Installing Ansible Galaxy requirements..."
ansible-galaxy install -r requirements.yml

echo ""
echo "Installation complete!"
echo ""
if ! command -v just &>/dev/null; then
  echo "Next steps:"
  echo "  ./bootstrap              # Run full bootstrap"
  echo "  ansible-playbook bootstrap.yml --tags minimal -K # Install minimal tools only"
  echo "  ansible-playbook bootstrap.yml --tags cli -K     # Install CLI tools only"
  echo "  ansible-playbook bootstrap.yml --tags gui -K     # Install GUI apps only"
  echo "  ansible-playbook bootstrap.yml --tags desktop -K # Install desktop config only"
else
  echo "Next steps:"
  echo "  just bootstrap           # Run full bootstrap"
  echo "  just minimal             # Install minimal tools only"
  echo "  just cli                 # Install CLI tools only"
  echo "  just gui                 # Install GUI apps only"
  echo "  just desktop             # Install desktop config only"
  echo "  just --list              # Show all available commands"
fi
echo ""

