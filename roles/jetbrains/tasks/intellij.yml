---
# CachyOS/Arch: install from AUR via paru
- name: Install IntelliJ IDEA Ultimate from AUR (CachyOS/Arch)
  command: paru -S --noconfirm --needed intellij-idea-ultimate-edition-jre
  args:
    creates: /usr/bin/idea
  when: ansible_facts.os_family == "Archlinux"

# Debian/Fedora: tarball installation
- name: Set IntelliJ IDEA Ultimate architecture suffix
  ansible.builtin.set_fact:
    intellij_arch: "{{ '-aarch64' if ansible_architecture == 'aarch64' else '' }}"
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

- name: Check if IntelliJ IDEA Ultimate is already installed
  ansible.builtin.stat:
    path: "{{ jetbrains_install_dir }}/intellij-idea-ultimate-{{ intellij_ultimate_version }}"
  register: intellij_dir
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

- name: Download IntelliJ IDEA Ultimate
  ansible.builtin.get_url:
    url: "https://download.jetbrains.com/idea/ideaIU-{{ intellij_ultimate_version }}{{ intellij_arch }}.tar.gz"
    dest: "/tmp/ideaIU-{{ intellij_ultimate_version }}{{ intellij_arch }}.tar.gz"
    checksum: "sha256:https://download.jetbrains.com/idea/ideaIU-{{ intellij_ultimate_version }}{{ intellij_arch }}.tar.gz.sha256"
    mode: '0644'
  when:
    - ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"
    - not intellij_dir.stat.exists

- name: Extract IntelliJ IDEA Ultimate
  ansible.builtin.unarchive:
    src: "/tmp/ideaIU-{{ intellij_ultimate_version }}{{ intellij_arch }}.tar.gz"
    dest: "{{ jetbrains_install_dir }}"
    remote_src: true
    creates: "{{ jetbrains_install_dir }}/intellij-idea-ultimate-{{ intellij_ultimate_version }}"
  when:
    - ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"
    - not intellij_dir.stat.exists

- name: Find IntelliJ IDEA Ultimate extracted directory
  ansible.builtin.find:
    paths: "{{ jetbrains_install_dir }}"
    patterns: "idea-IU-*"
    file_type: directory
  register: intellij_extracted
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

- name: Rename IntelliJ IDEA Ultimate directory to versioned name
  ansible.builtin.command:
    cmd: "mv {{ intellij_extracted.files[0].path }} {{ jetbrains_install_dir }}/intellij-idea-ultimate-{{ intellij_ultimate_version }}"
  when:
    - ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"
    - intellij_extracted.matched > 0
    - not intellij_dir.stat.exists

- name: Create symlink for IntelliJ IDEA Ultimate
  ansible.builtin.file:
    src: "{{ jetbrains_install_dir }}/intellij-idea-ultimate-{{ intellij_ultimate_version }}/bin/idea"
    dest: "{{ jetbrains_bin_dir }}/idea"
    state: link
    force: true
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

- name: Ensure applications directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/applications"
    state: directory
    mode: '0755'
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

- name: Ensure icons directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/icons/hicolor/scalable/apps"
    state: directory
    mode: '0755'
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

- name: Install IntelliJ IDEA Ultimate icon
  ansible.builtin.copy:
    src: "{{ jetbrains_install_dir }}/intellij-idea-ultimate-{{ intellij_ultimate_version }}/bin/idea.svg"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/icons/hicolor/scalable/apps/idea.svg"
    mode: '0644'
    remote_src: true
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

- name: Install IntelliJ IDEA Ultimate .desktop file
  ansible.builtin.copy:
    src: jetbrains-idea.desktop
    dest: "{{ ansible_facts.env.HOME }}/.local/share/applications/jetbrains-idea.desktop"
    mode: '0644'
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

# macOS installation
- name: Install IntelliJ IDEA Ultimate on macOS
  community.general.homebrew_cask:
    name: intellij-idea
    state: present
  when: ansible_facts.distribution == "MacOSX"
