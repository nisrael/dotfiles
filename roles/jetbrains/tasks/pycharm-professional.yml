---
# Linux installation
- name: Set PyCharm Professional architecture suffix
  ansible.builtin.set_fact:
    pycharm_arch: "{{ '-aarch64' if ansible_architecture == 'aarch64' else '' }}"
  when: ansible_system == "Linux"

- name: Check if PyCharm Professional is already installed
  ansible.builtin.stat:
    path: "{{ jetbrains_install_dir }}/pycharm-professional-{{ pycharm_professional_version }}"
  register: pycharm_dir
  when: ansible_system == "Linux"

- name: Download PyCharm
  ansible.builtin.get_url:
    url: "https://download.jetbrains.com/python/pycharm-{{ pycharm_professional_version }}{{ pycharm_arch }}.tar.gz"
    dest: "/tmp/pycharm-{{ pycharm_professional_version }}{{ pycharm_arch }}.tar.gz"
    checksum: "sha256:https://download.jetbrains.com/python/pycharm-{{ pycharm_professional_version }}{{ pycharm_arch }}.tar.gz.sha256"
    mode: '0644'
  when:
    - ansible_system == "Linux"
    - not pycharm_dir.stat.exists

- name: Extract PyCharm
  ansible.builtin.unarchive:
    src: "/tmp/pycharm-{{ pycharm_professional_version }}{{ pycharm_arch }}.tar.gz"
    dest: "{{ jetbrains_install_dir }}"
    remote_src: true
    creates: "{{ jetbrains_install_dir }}/pycharm-professional-{{ pycharm_professional_version }}"
  when:
    - ansible_system == "Linux"
    - not pycharm_dir.stat.exists

- name: Find PyCharm Professional extracted directory
  ansible.builtin.find:
    paths: "{{ jetbrains_install_dir }}"
    patterns: "pycharm-*"
    file_type: directory
  register: pycharm_extracted
  when: ansible_system == "Linux"

- name: Rename PyCharm Professional directory to versioned name
  ansible.builtin.command:
    cmd: "mv {{ pycharm_extracted.files[0].path }} {{ jetbrains_install_dir }}/pycharm-professional-{{ pycharm_professional_version }}"
  when:
    - ansible_system == "Linux"
    - pycharm_extracted.matched > 0
    - not pycharm_dir.stat.exists

- name: Create symlink for PyCharm Professional
  ansible.builtin.file:
    src: "{{ jetbrains_install_dir }}/pycharm-professional-{{ pycharm_professional_version }}/bin/pycharm"
    dest: "{{ jetbrains_bin_dir }}/pycharm"
    state: link
    force: true
  when: ansible_system == "Linux"

# macOS installation
- name: Install PyCharm Professional on macOS
  community.general.homebrew_cask:
    name: pycharm
    state: present
  when: ansible_distribution == "MacOSX"
