#!/bin/bash
# Bluetooth menu using fuzzel and bluetoothctl

# Check if bluetoothctl is available
if ! command -v bluetoothctl &> /dev/null; then
    notify-send "Error" "bluetoothctl not found. Install bluez."
    exit 1
fi

# Get bluetooth status
bt_status=$(bluetoothctl show | grep "Powered:" | awk '{print $2}')

# Build menu options
menu="Toggle Bluetooth [$bt_status]\n"
menu+="Scan for devices\n"
menu+="---\n"

# Get paired devices
paired=$(bluetoothctl devices Paired | while read -r line; do
    mac=$(echo "$line" | awk '{print $2}')
    name=$(echo "$line" | cut -d' ' -f3-)
    
    # Check if connected
    connected=$(bluetoothctl info "$mac" | grep "Connected:" | awk '{print $2}')
    if [ "$connected" = "yes" ]; then
        echo "✓ $name [Disconnect]"
    else
        echo "  $name [Connect]"
    fi
done)

if [ -n "$paired" ]; then
    menu+="$paired\n"
    menu+="---\n"
fi

menu+="Show all devices"

# Show menu
selected=$(echo -e "$menu" | fuzzel --dmenu --prompt "Bluetooth: ")

if [ -z "$selected" ]; then
    exit 0
fi

# Handle selection
case "$selected" in
    "Toggle Bluetooth"*)
        if [ "$bt_status" = "yes" ]; then
            bluetoothctl power off
            notify-send "Bluetooth" "Bluetooth disabled"
        else
            bluetoothctl power on
            notify-send "Bluetooth" "Bluetooth enabled"
        fi
        ;;
    "Scan for devices")
        notify-send "Bluetooth" "Scanning for devices..."
        bluetoothctl --timeout 10 scan on &
        sleep 10
        
        # Show discovered devices
        devices=$(bluetoothctl devices | while read -r line; do
            mac=$(echo "$line" | awk '{print $2}')
            name=$(echo "$line" | cut -d' ' -f3-)
            echo "$name"
        done)
        
        selected_device=$(echo "$devices" | fuzzel --dmenu --prompt "Select device: ")
        
        if [ -n "$selected_device" ]; then
            mac=$(bluetoothctl devices | grep "$selected_device" | awk '{print $2}')
            notify-send "Bluetooth" "Pairing with $selected_device..."
            bluetoothctl pair "$mac"
            bluetoothctl trust "$mac"
            bluetoothctl connect "$mac"
            notify-send "Bluetooth" "Attempted to pair with $selected_device"
        fi
        ;;
    "Show all devices")
        devices=$(bluetoothctl devices | while read -r line; do
            mac=$(echo "$line" | awk '{print $2}')
            name=$(echo "$line" | cut -d' ' -f3-)
            connected=$(bluetoothctl info "$mac" | grep "Connected:" | awk '{print $2}')
            if [ "$connected" = "yes" ]; then
                echo "✓ $name"
            else
                echo "  $name"
            fi
        done)
        
        selected_device=$(echo "$devices" | fuzzel --dmenu --prompt "Devices: ")
        
        if [ -n "$selected_device" ]; then
            device_name=$(echo "$selected_device" | sed 's/^[✓ ]*//')
            mac=$(bluetoothctl devices | grep "$device_name" | awk '{print $2}')
            
            # Show device actions
            action=$(echo -e "Connect\nDisconnect\nRemove" | fuzzel --dmenu --prompt "$device_name: ")
            
            case "$action" in
                "Connect")
                    bluetoothctl connect "$mac" && \
                        notify-send "Bluetooth" "Connected to $device_name" || \
                        notify-send "Bluetooth" "Failed to connect to $device_name"
                    ;;
                "Disconnect")
                    bluetoothctl disconnect "$mac" && \
                        notify-send "Bluetooth" "Disconnected from $device_name" || \
                        notify-send "Bluetooth" "Failed to disconnect from $device_name"
                    ;;
                "Remove")
                    bluetoothctl remove "$mac" && \
                        notify-send "Bluetooth" "Removed $device_name" || \
                        notify-send "Bluetooth" "Failed to remove $device_name"
                    ;;
            esac
        fi
        ;;
    "---")
        exit 0
        ;;
    *)
        # Handle paired device selection
        if echo "$selected" | grep -q "\[Connect\]"; then
            device_name=$(echo "$selected" | sed 's/^  //' | sed 's/ \[Connect\]$//')
            mac=$(bluetoothctl devices Paired | grep "$device_name" | awk '{print $2}')
            bluetoothctl connect "$mac" && \
                notify-send "Bluetooth" "Connected to $device_name" || \
                notify-send "Bluetooth" "Failed to connect to $device_name"
        elif echo "$selected" | grep -q "\[Disconnect\]"; then
            device_name=$(echo "$selected" | sed 's/^✓ //' | sed 's/ \[Disconnect\]$//')
            mac=$(bluetoothctl devices Paired | grep "$device_name" | awk '{print $2}')
            bluetoothctl disconnect "$mac" && \
                notify-send "Bluetooth" "Disconnected from $device_name" || \
                notify-send "Bluetooth" "Failed to disconnect from $device_name"
        fi
        ;;
esac
