---
- name: Add Vivaldi GPG key (Ubuntu)
  become: true
  ansible.builtin.get_url:
    url: https://repo.vivaldi.com/archive/linux_signing_key.pub
    dest: /usr/share/keyrings/vivaldi-browser.asc
    mode: '0644'
  when: ansible_distribution == "Ubuntu"

- name: Add Vivaldi repository (Ubuntu)
  become: true
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/vivaldi-browser.asc] https://repo.vivaldi.com/archive/deb/ stable main"
    filename: vivaldi
    state: present
  when: ansible_distribution == "Ubuntu"

- name: Install Vivaldi (Ubuntu)
  become: true
  apt:
    name:
      - vivaldi-stable
    state: present
    update_cache: true
  when: ansible_distribution == "Ubuntu"

- name: Add Vivaldi GPG key (Fedora)
  become: true
  ansible.builtin.rpm_key:
    key: https://repo.vivaldi.com/archive/linux_signing_key.pub
    state: present
  when: ansible_distribution == "Fedora"

- name: Add Vivaldi repository (Fedora)
  become: true
  ansible.builtin.yum_repository:
    name: vivaldi
    description: Vivaldi Browser Repository
    baseurl: https://repo.vivaldi.com/archive/rpm/x86_64
    enabled: true
    gpgcheck: true
    gpgkey: https://repo.vivaldi.com/archive/linux_signing_key.pub
  when: ansible_distribution == "Fedora"

- name: Install Vivaldi (Fedora)
  become: true
  dnf:
    name:
      - vivaldi-stable
    state: present
  when: ansible_distribution == "Fedora"

- name: Create 1Password configuration directory
  become: true
  ansible.builtin.file:
    path: /etc/1password
    state: directory
    mode: '0755'
    owner: root
    group: root
  when: ansible_distribution == "Ubuntu" or ansible_distribution == "Fedora"

- name: Add Vivaldi to 1Password allowed browsers
  become: true
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: vivaldi-bin
    create: true
    mode: '0644'
    owner: root
    group: root
  when: ansible_distribution == "Ubuntu" or ansible_distribution == "Fedora"
