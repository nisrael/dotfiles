---
# CachyOS/Arch: install from AUR via paru
- name: Install tlrc from AUR (CachyOS/Arch)
  command: paru -S --noconfirm --needed tlrc
  args:
    creates: /usr/bin/tldr
  when: ansible_facts.os_family == "Archlinux"

# Debian/Fedora: binary download
- name: Check if tlrc is already installed
  stat:
    path: "{{ ansible_facts.env.HOME }}/.local/bin/tldr"
  register: tlrc_installed
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux"

- name: Download tlrc archive in Linux (x86_64)
  get_url:
    url: "https://github.com/tldr-pages/tlrc/releases/download/v{{ tlrc_version }}/tlrc-v{{ tlrc_version }}-x86_64-unknown-linux-musl.tar.gz"
    dest: "/tmp/tlrc.tar.gz"
    mode: '0644'
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux" and ansible_facts.architecture == "x86_64" and not tlrc_installed.stat.exists

- name: Extract tldr binary (x86_64)
  shell: tar -xzf /tmp/tlrc.tar.gz -C {{ ansible_facts.env.HOME }}/.local/bin tldr
  args:
    creates: "{{ ansible_facts.env.HOME }}/.local/bin/tldr"
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux" and ansible_facts.architecture == "x86_64" and not tlrc_installed.stat.exists

- name: Make tldr executable (x86_64)
  file:
    path: "{{ ansible_facts.env.HOME }}/.local/bin/tldr"
    mode: '0755'
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux" and ansible_facts.architecture == "x86_64" and not tlrc_installed.stat.exists

- name: Clean up tlrc download
  file:
    path: /tmp/tlrc.tar.gz
    state: absent
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux" and ansible_facts.architecture == "x86_64" and not tlrc_installed.stat.exists

- name: Install tlrc in Linux (aarch64)
  command: "{{ ansible_facts.env.HOME }}/.cargo/bin/cargo install tlrc"
  args:
    creates: "{{ ansible_facts.env.HOME }}/.cargo/bin/tldr"
  environment:
    PATH: "{{ ansible_facts.env.HOME }}/.cargo/bin:{{ ansible_facts.env.PATH }}"
  when: ansible_facts.system == "Linux" and ansible_facts.os_family != "Archlinux" and ansible_facts.architecture == "aarch64" and not tlrc_installed.stat.exists

# tlrc installation disabled on macOS - using tealdeer instead
# Config is kept for compatibility
# - name: Install tlrc in macOS
#   community.general.homebrew:
#     name: tlrc
#     state: present
#   when: ansible_facts.distribution == "MacOSX"
