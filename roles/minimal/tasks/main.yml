---
# Core CLI Setup
- name: Create common user directories
  file:
    path: "{{ ansible_facts.env.HOME }}/{{ item }}"
    state: directory
    mode: 0755
  loop:
    - .local/bin
    - .local/share/applications
    - .config

- name: Install Development Tools in Debian/Ubuntu
  become: true
  apt:
    name:
      - build-essential
      - linux-headers-generic
    state: present
  when: ansible_facts.os_family == "Debian"

- name: Install CLI tools in Debian/Ubuntu
  become: true
  apt:
    name:
      - tmux
      - ripgrep
      - fd-find
      - jq
      - htop
      - btop
      - python3-pip
      - pipx
      - unzip
      - mc
      - moreutils
      - bash-completion
      - bat
      - tealdeer
      - curl
      - command-not-found
      - duf
      - ncdu
      - gnupg
    state: present
  when: ansible_facts.os_family == "Debian"

- name: Install starship via apt (newer Debian/Ubuntu)
  become: true
  apt:
    name: starship
    state: present
  when: >
    (ansible_facts.distribution == "Ubuntu" and ansible_facts.distribution_version is version('25.04', '>=')) or
    (ansible_facts.distribution == "Debian" and ansible_facts.distribution_major_version|int >= 13)

- name: Install starship via script (older Debian/Ubuntu)
  become: true
  shell: curl -sS https://starship.rs/install.sh | sh -s -- -y
  args:
    creates: /usr/local/bin/starship
  when: >
    ansible_facts.os_family == "Debian" and
    not ((ansible_facts.distribution == "Ubuntu" and ansible_facts.distribution_version is version('25.04', '>=')) or
         (ansible_facts.distribution == "Debian" and ansible_facts.distribution_major_version|int >= 13))


- name: Install Development Tools in Fedora
  become: true
  dnf:
    name:
      - "@Development Tools"
    state: present
  when: ansible_facts.os_family == "RedHat"

- name: Install CLI tools in Fedora
  become: true
  dnf:
    name:
      - tmux
      - ripgrep
      - fd-find
      - jq
      - htop
      - btop
      - python3-pip
      - python3-dnf
      - mc
      - moreutils
      - gawk
      - bash-completion
      - bat
      - tealdeer
      - PackageKit-command-not-found
      - duf
      - ncdu
    state: present
  when: ansible_facts.os_family == "RedHat"

- name: Install starship via script (Fedora)
  become: true
  shell: curl -sS https://starship.rs/install.sh | sh -s -- -y
  args:
    creates: /usr/local/bin/starship
  when: ansible_facts.os_family == "RedHat"

- name: Install CLI tools in macOS
  community.general.homebrew:
    name:
      - tmux
      - ripgrep
      - fd
      - jq
      - htop
      - btop
      - mc
      - moreutils
      - gnu-tar
      - bash-completion@2
      - bat
      - tealdeer
      - starship
      - duf
      - ncdu
    state: present
  when: ansible_facts.distribution == "MacOSX"

- name: Install Development Tools in CachyOS/Arch
  become: true
  community.general.pacman:
    name:
      - base-devel
      - linux-headers
    state: present
  when: ansible_facts.os_family == "Archlinux"

- name: Install CLI tools in CachyOS/Arch
  become: true
  community.general.pacman:
    name:
      - tmux
      - ripgrep
      - fd
      - jq
      - htop
      - btop
      - python-pip
      - python-pipx
      - unzip
      - mc
      - moreutils
      - bash-completion
      - bat
      - tealdeer
      - starship
      - duf
      - ncdu
      - gnupg
    state: present
  when: ansible_facts.os_family == "Archlinux"

- name: Update pacman cache (CachyOS)
  become: true
  community.general.pacman:
    update_cache: true
  when: ansible_facts.distribution == "CachyOS"

# Shell
- name: Install zsh
  import_tasks: zsh.yml

# Note: zsh-autosuggestions and zsh-syntax-highlighting are managed by Zinit in .zshrc
# and don't need to be installed via package manager

# Stow
- name: Install stow
  import_tasks: stow.yml

- name: Remove files that will conflict with Stow
  loop:
    - .bashrc
    - .bash_profile
    - .profile
    - .gitconfig
    - .config/alacritty/alacritty.toml
    - .config/git/ignore
    - .config/mc/ini
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/{{ item }}"
    state: absent

- name: Generate platform-specific .gitconfig
  ansible.builtin.template:
    src: gitconfig.j2
    dest: "{{ ansible_facts.env.HOME }}/.gitconfig"
    mode: '0644'

- name: Ensure .config/alacritty directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/alacritty"
    state: directory
    mode: '0755'

- name: Generate platform-specific alacritty.toml
  ansible.builtin.template:
    src: alacritty.toml.j2
    dest: "{{ ansible_facts.env.HOME }}/.config/alacritty/alacritty.toml"
    mode: '0644'

- name: Run stow
  shell: "stow . --target {{ ansible_facts.env.HOME }} --verbose=2"
  args:
    chdir: "{{ ansible_facts.env.HOME }}/dotfiles"
  register: result
  changed_when: 'result.stderr is search("LINK: ")'

# CLI Tools
- name: Install vim
  import_tasks: vim.yml
